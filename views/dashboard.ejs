<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetTrack Dashboard</title>
    
    <!-- Leaflet & Fonts -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #e74c3c;
            --dark-blue: #2c3e50;
            --light-gray: #ecf0f1;
            --text-color: #34495e;
            --white: #ffffff;
            --border-color: #bdc3c7;
        }
        body { margin:0; font-family:'Inter', sans-serif; height:100vh; overflow:hidden; display:flex; flex-direction:column; background-color:var(--light-gray); }
        
        /* Navbar */
        #navbar {
            background-color: var(--white);
            color: var(--text-color);
            padding: 0 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            height: 65px;
            border-bottom: 1px solid #ddd;
        }
        #navbar .menu { display: flex; align-items: center; height: 100%; }
        #navbar .logo-container { display: flex; align-items: center; padding-right: 25px; border-right: 1px solid #e0e0e0; height: 100%; }
        #navbar .logo { height: 35px; }
        #navbar .nav-links { display: flex; align-items: center; height: 100%; margin-left: 15px; }
        #navbar .nav-links a {
            cursor: pointer; padding: 0 15px; border-bottom: 3px solid transparent; transition: all .3s ease;
            font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 0.95em;
            color: var(--text-color); text-decoration: none; height: 100%;
        }
        #navbar .nav-links a:hover, #navbar .nav-links a.selected {
            color: var(--primary-color); border-bottom-color: var(--primary-color); background-color: #f8f9fa;
        }

        /* Dropdown Styles - Updated for Click interaction */
        .dropdown { position: relative; display: inline-block; height: 100%; }
        .dropbtn { 
            height: 100%; padding: 0 15px; cursor: pointer; display: flex; align-items: center; 
            gap: 8px; font-weight: 600; font-size: 0.95em; color: var(--text-color); border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        /* Use .show class instead of :hover */
        .dropdown.show .dropdown-content { display: block; }
        .dropdown.show .dropbtn { color: var(--primary-color); background-color: #f8f9fa; border-bottom-color: var(--primary-color); }
        
        .dropdown-content {
            display: none; position: absolute; background-color: var(--white); min-width: 220px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1); z-index: 1001; border-radius: 8px;
            border: 1px solid #ddd; overflow: hidden; right: 0; top: 65px;
        }
        .dropdown-content a {
            color: var(--text-color); padding: 12px 16px; text-decoration: none; display: flex;
            align-items: center; gap: 10px; font-size: 0.9em; transition: background-color 0.2s;
        }
        .dropdown-content a:hover { background-color: #f1f1f1; color: var(--primary-color); }

        .user-account { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-color); color: var(--white); display: flex; justify-content: center; align-items: center; font-weight: 600; }

        /* Layout */
        #main { flex:1; display:flex; height:calc(100% - 65px); position:relative; }
        #sidebar {
            width: 320px; background: var(--white); overflow-y: auto; border-right: 1px solid var(--border-color);
            box-shadow: 3px 0 10px rgba(0,0,0,.05); flex-shrink: 0; z-index: 500;
        }
        #sidebar-content { padding: 20px; }
        #map { flex:1; height:100%; background-color:#e6e6e6; z-index:1; }

        /* Vehicle List */
        .device-item {
            cursor: pointer; padding: 12px; margin-bottom: 8px; background: #fdfdfd;
            border: 1px solid #e9e9e9; border-left: 4px solid var(--border-color);
            border-radius: 8px; transition: all .2s ease;
        }
        .device-item:hover { background: #f5faff; border-left-color: #3498db; }
        .device-item.selected { border-left-color: var(--primary-color); background-color: #fff5f5; }
        .device-name { font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .online { background:#2ecc71; }
        .offline { background:#95a5a6; }
        .pending-count { background: var(--primary-color); color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7em; }
    </style>
</head>
<body>

    <div id="navbar">
        <div class="menu">
            <div class="logo-container">
                <img src="/icons/avlogo.png" class="logo" alt="Logo" onerror="this.src='https://placehold.co/120x40?text=AVEGA'">
            </div>
            <div class="nav-links">
                <a href="/dashboard" class="selected">
                    <img src="https://cdn-icons-png.flaticon.com/512/3063/3063822.png" width="20" height="20">
                    Vehicles
                </a>
            </div>
        </div>
        
        <div class="user-account">
            <div class="dropdown" id="subsystemDropdown">
                <div class="dropbtn">
                    <img src="https://cdn-icons-png.flaticon.com/512/566/566001.png" width="22">
                    Subsystems
                </div>
                <div class="dropdown-content">
                    <a href="/trips">ðŸ•’ Trip History</a>
                    <a href="/trip-tickets">ðŸ§¾ Trip Tickets</a>
                    <% if (user.role === 'admin') { %>
                        <a href="/trip-tickets/approvals">
                            âœ… Approvals 
                            <% if (pendingCount > 0) { %><span class="pending-count"><%= pendingCount %></span><% } %>
                        </a>
                        <a href="/vehicles">ðŸš› Manage Vehicles</a>
                        <a href="/users">ðŸ‘¥ User Management</a>
                    <% } %>
                </div>
            </div>

            <div class="user-avatar"><%= user.username.charAt(0).toUpperCase() %></div>
            <div class="user-details">
                <div class="user-name">Welcome, <%= user.username %></div>
                <div class="user-role" style="font-size: 0.8em; color: #777;"><%= user.role.toUpperCase() %></div>
            </div>
            <a href="/logout" style="text-decoration:none; font-size:1.2rem; margin-left:10px;">ðŸšª</a>
        </div>
    </div>

    <div id="main">
        <div id="sidebar">
            <div id="sidebar-content">
                <h3 style="margin-top:0;">Live Vehicles</h3>
                <div id="device-list">
                    <% if (vehicles.length === 0) { %>
                        <p style="color:#777; font-size:0.9em;">No vehicles registered.</p>
                    <% } %>
                    <% vehicles.forEach(v => { %>
                        <div class="device-item" onclick="focusVehicle('<%= v.id %>', <%= v.latitude %>, <%= v.longitude %>)">
                            <div class="device-name">
                                <span class="status-dot <%= v.status %>"></span>
                                <span><%= v.plate_number || v.imei %></span>
                            </div>
                            <div style="font-size: 0.8em; color: #777; margin-top:4px;">
                                Driver: <%= v.driver_name || 'N/A' %> | <%= v.speed %> km/h
                            </div>
                        </div>
                    <% }) %>
                </div>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([10.3157, 123.8854], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        const markers = {};

        // Dropdown toggle logic
        const dropdown = document.getElementById('subsystemDropdown');
        if (dropdown) {
            const dropdownBtn = dropdown.querySelector('.dropbtn');
            dropdownBtn.addEventListener('click', function(event) {
                event.stopPropagation();
                dropdown.classList.toggle('show');
            });
        }

        // Close dropdown if clicked outside
        window.addEventListener('click', function(event) {
            if (dropdown && dropdown.classList.contains('show')) {
                if (!dropdown.contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            }
        });

        // Function to update/create markers
        function updateMarkers() {
            fetch('/map/data')
                .then(res => res.json())
                .then(data => {
                    data.forEach(v => {
                        if (!v.latitude || !v.longitude) return;
                        
                        const latlng = [v.latitude, v.longitude];
                        const iconColor = v.speed > 0 ? '#2ecc71' : '#95a5a6';

                        if (markers[v.id]) {
                            markers[v.id].setLatLng(latlng);
                        } else {
                            markers[v.id] = L.marker(latlng, {
                                icon: L.divIcon({
                                    className: 'custom-div-icon',
                                    html: `<div style="background-color:${iconColor}; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow:0 0 5px rgba(0,0,0,0.3);"></div>`,
                                    iconSize: [16, 16],
                                    iconAnchor: [8, 8]
                                })
                            }).bindPopup(`<b>${v.plate || v.imei}</b><br>Speed: ${v.speed} km/h`).addTo(map);
                        }
                    });
                });
        }

        function focusVehicle(id, lat, lng) {
            if (lat && lng) {
                map.setView([lat, lng], 16);
                if (markers[id]) markers[id].openPopup();
            }
        }

        // Initial update and interval
        updateMarkers();
        setInterval(updateMarkers, 5000);
    </script>
</body>
</html>